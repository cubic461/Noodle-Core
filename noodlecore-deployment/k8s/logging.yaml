
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: noodle-core-logging
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*noodle-core*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <source>
      @type tail
      path /var/log/containers/*postgres*.log
      pos_file /var/log/fluentd-postgres.log.pos
      tag kubernetes.postgres.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <source>
      @type tail
      path /var/log/containers/*redis*.log
      pos_file /var/log/fluentd-redis.log.pos
      tag kubernetes.redis.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <source>
      @type tail
      path /var/log/containers/*prometheus*.log
      pos_file /var/log/fluentd-prometheus.log.pos
      tag kubernetes.prometheus.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <source>
      @type tail
      path /var/log/containers/*grafana*.log
      pos_file /var/log/fluentd-grafana.log.pos
      tag kubernetes.grafana.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <source>
      @type tail
      path /var/log/containers/*alertmanager*.log
      pos_file /var/log/fluentd-alertmanager.log.pos
      tag kubernetes.alertmanager.*
      format json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>

    <filter kubernetes.**>
      @type kubernetes_metadata
      @id kubernetes_metadata
    </filter>

    <filter kubernetes.**>
      @type record_transformer
      @id enrich_logs
      <record>
        hostname ${record["host"]}
        service_name ${record["kubernetes"]["labels"]["app"]}
        component ${record["kubernetes"]["labels"]["component"]}
        namespace ${record["kubernetes"]["namespace"]}
        pod_name ${record["kubernetes"]["pod_name"]}
        container_name ${record["kubernetes"]["container_name"]}
      </record>
    </filter>

    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch-service
      port 9200
      index_name noodle-core-logs
      type_name _doc
      include_tag_key true
      tag_key @log_name
      flush_interval 5s
      max_retry_wait 300
      disable_retry_limit false
      retry_max_interval 600
      reload_on true
      @log_level info
    </match>

    <match fluent.**>
      @type null
    </match>
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: noodle-core-logging
  labels:
    app: fluentd
    component: logging
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
        component: logging
    spec:
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      containers:
      - name: fluentd
        image: fluent/fluentd:v1.16-1
        resources:
          limits:
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluentd-config
          mountPath: /fluentd/etc
        securityContext:
          privileged: true
          runAsUser: 0
      terminationGracePeriodSeconds: 30
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluentd-config
        configMap:
          name: fluentd-config
---
apiVersion: v1
kind: Service
metadata:
  name: fluentd-service
  namespace: noodle-core-logging
  labels:
    app: fluentd
    component: logging
spec:
  selector:
    app: fluentd
  ports:
  - port: 24224
    targetPort: 24224
    name: fluentd
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-config
  namespace: noodle-core-logging
data:
  elasticsearch.yml: |
    cluster.name: noodle-core-logging
    node.name: es-node-1
    network.host: 0.0.0.0
    http.port: 9200
    transport.tcp.port: 9300
    discovery.type: single-node
    path.data: /usr/share/elasticsearch/data
    path.logs: /usr/share/elasticsearch/logs
    xpack.security.enabled: false
    xpack.monitoring.enabled: true
    xpack.watcher.enabled: false
    xpack.graph.enabled: false
    xpack.ml.enabled: false
    xpack.security.enrollment.enabled: false
    xpack.security.authc.api_key.enabled: false
    xpack.security.authc.token.enabled: false
    xpack.security.audit.enabled: false
    xpack.security.transport.ssl.enabled: false
    xpack.security.http.ssl.enabled: false
    xpack.security.http.ssl.verification_mode: none
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: none
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.certificate: none
    xpack.security.http.ssl.key: none
    xpack.security.http.ssl.certificate_authorities: []
    xpack.security.http.ssl.supported_protocols: TLSv1.2,TLSv1.3
    xpack.security.http.ssl.enabled_protocols: TLSv1.2,T