# Migration Mode Workflow Documentation

## Overview

Migration Mode is a systematic approach to migrating code from one language to another (e.g., Python â†’ Go) while preserving functionality and behavior. This document outlines the complete workflow:

**Observe â†’ Generate â†’ Scaffold â†’ Verify â†’ Report**

---

## Table of Contents

1. [Introduction](#introduction)
2. [Workflow Steps](#workflow-steps)
   - [Step 1: Observe](#step-1-observe)
   - [Step 2: Generate](#step-2-generate)
   - [Step 3: Scaffold](#step-3-scaffold)
   - [Step 4: Verify](#step-4-verify)
   - [Step 5: Report](#step-5-report)
3. [Demo Scripts](#demo-scripts)
4. [Golden Test Format](#golden-test-format)
5. [Usage Examples](#usage-examples)
6. [Troubleshooting](#troubleshooting)

---

## Introduction

### What is Migration Mode?

Migration Mode is a structured approach to code migration that ensures behavior preservation through:

- **Execution Tracing**: Capture detailed traces of source code behavior
- **Golden Tests**: Generate regression tests from execution traces
- **Code Scaffolding**: Auto-generate target language structure
- **Behavioral Verification**: Compare source and target outputs
- **Comprehensive Reporting**: Document migration results

### Key Benefits

âœ“ **Behavior Preservation**: Ensures migrated code produces identical outputs  
âœ“ **Regression Testing**: Creates test suite for future changes  
âœ“ **Automated Validation**: Reduces manual testing effort  
âœ“ **Comprehensive Documentation**: Tracks all migration steps  
âœ“ **Risk Mitigation**: Early detection of behavioral differences

### Supported Languages

- **Source**: Python (with tracing support)
- **Target**: Go (scaffolding and verification)

---

## Workflow Steps

### Step 1: Observe

**Purpose**: Execute source code and capture detailed execution traces

**What it does**:
- Runs the Python source code
- Captures file I/O operations
- Records command execution details
- Monitors execution time and exit codes
- Saves trace data to JSON file

**Input**:
- Python script to execute
- Input files for the script
- Working directory

**Output**:
- `python_trace.json` - Complete execution trace
- Artifacts generated by script execution

**Example Trace Structure**:
```json
{
  "trace_id": "python_demo_1702608000",
  "language": "python",
  "command": ["python", "processor.py", "input.txt", "output.txt"],
  "working_dir": "/path/to/working/dir",
  "start_time": 1702608000.0,
  "end_time": 1702608015.5,
  "exit_code": 0,
  "io_log": [
    {
      "operation": "read",
      "path": "/path/to/input.txt",
      "success": true,
      "timestamp": 1702608005.0
    },
    {
      "operation": "create",
      "path": "/path/to/output.txt",
      "success": true,
      "timestamp": 1702608010.0
    }
  ]
}
```

**Command-Line Usage**:
```bash
# Run Python script with execution tracing
python migration_mode_demo.py --steps observe

# Or using the main demo
python migration_mode_demo.py --full
```

**Success Criteria**:
âœ“ Script executes successfully (exit code 0)  
âœ“ Output files created  
âœ“ Trace data captured  
âœ“ No runtime errors

---

### Step 2: Generate

**Purpose**: Convert execution traces into golden tests

**What it does**:
- Analyzes trace data
- Identifies file operations
- Extracts expected outputs
- Generates golden test assertions
- Creates regression test suite

**Input**:
- `python_trace.json` from Observe step

**Output**:
- `generated_golden_test.json` - Golden test specification
- Test assertions for all observed behaviors

**Golden Test Structure**:
```json
{
  "test_suite_name": "python_migration_demo",
  "format_version": "1.0.0",
  "description": "Golden tests from Python execution",
  "tests": [
    {
      "test_id": "file_processing_test",
      "description": "Process input file and generate uppercase output",
      "enabled": true,
      "priority": "high",
      "setup": {
        "create_files": [...],
        "environment": {}
      },
      "input": {
        "command": ["python", "processor.py", "input.txt", "output.txt"],
        "working_dir": ".",
        "timeout_seconds": 30
      },
      "expected_output": {
        "exit_code": 0,
        "stdout": "",
        "stderr": ""
      },
      "expected_files": [
        {
          "path": "output.txt",
          "should_exist": true,
          "content_match": "HELLO WORLD\n"
        }
      ],
      "assertions": [
        {
          "type": "file_exists",
          "file_path": "output.txt"
        },
        {
          "type": "exit_code",
          "expected_code": 0
        }
      ]
    }
  ],
  "metadata": {...}
}
```

**Command-Line Usage**:
```bash
# Generate golden tests from trace
python migration_mode_demo.py --steps generate

# Custom trace file
python trace_to_golden_converter.py python_trace.json -o golden_tests
```

**Success Criteria**:
âœ“ Trace file parsed successfully  
âœ“ Golden tests generated  
âœ“ Assertions cover key behaviors  
âœ“ Test specifications valid

---

### Step 3: Scaffold

**Purpose**: Generate target language (Go) code structure from source

**What it does**:
- Analyzes Python code structure
- Maps Python constructs to Go equivalents
- Generates Go source files
- Creates project structure
- Adds necessary dependencies

**Input**:
- Python source code
- Inferred dependencies
- Target language requirements

**Output**:
- Go project structure (`go_scaffold/`)
- `main.go` - Main Go source file
- `go.mod` - Go module definition

**Generated Go Structure**:
```
go_scaffold/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.go          # Generated Go equivalent
â”œâ”€â”€ go.mod               # Module definition
â””â”€â”€ README.md            # Usage instructions
```

**Command-Line Usage**:
```bash
# Scaffold Go project from Python
python migration_mode_demo.py --steps scaffold

# Manual scaffolding (requires Go)
python -c "
from migration_mode_demo import MigrationDemo
demo = MigrationDemo()
demo.step_scaffold()
"
```

**Success Criteria**:
âœ“ Go project structure created  
âœ“ Source files generated  
âœ“ Code compiles without errors  
âœ“ Dependencies resolved

---

### Step 4: Verify

**Purpose**: Compare target implementation against golden tests

**What it does**:
- Executes golden tests
- Runs both Python and Go implementations
- Compares outputs byte-for-byte
- Identifies behavioral differences
- Reports verification results

**Input**:
- Golden test specifications
- Python baseline output
- Go implementation output

**Output**:
- Verification comparison report
- Success/failure status
- Detailed difference analysis

**Verification Process**:
1. **Build Go Code**: Compile scaffolded Go program
2. **Execute Baseline**: Run Python original with test inputs
3. **Execute Target**: Run Go implementation with same inputs
4. **Compare Outputs**: Byte-for-byte comparison
5. **Analyze Differences**: Identify and categorize mismatches

**Comparison Levels**:
- **File Existence**: Do expected files exist?
- **Content Match**: Exact byte-for-byte comparison
- **Line-by-Line**: Finding first differing line
- **Size Metrics**: File size and line count differences

**Command-Line Usage**:
```bash
# Run verification
python migration_mode_demo.py --steps verify

# With verbose output
python migration_mode_demo.py --full --verbose
```

**Success Criteria**:
âœ“ Go code compiles successfully  
âœ“ Both implementations produce outputs  
âœ“ Outputs match exactly (for deterministic operations)  
âœ“ No runtime errors

---

### Step 5: Report

**Purpose**: Generate comprehensive migration summary and recommendations

**What it does**:
- Aggregates results from all steps
- Calculates timing and success metrics
- Generates detailed summary
- Provides actionable recommendations
- Saves structured report

**Input**:
- Results from Steps 1-4
- Timing information
- Success/failure status

**Output**:
- `migration_report.json` - Structured report
- Console summary display
- Step-by-step results
- Recommendations

**Report Structure**:
```json
{
  "migration_id": "migration_1702608000",
  "start_time": "2025-12-14T10:00:00",
  "end_time": "2025-12-14T10:05:30",
  "total_duration": 330.5,
  "steps_completed": 5,
  "steps_total": 5,
  "overall_status": "SUCCESS",
  "detailed_results": [
    {
      "step": "observe",
      "status": "SUCCESS",
      "duration": 15.5,
      "artifacts_count": 2
    },
    ...
  ],
  "verification": {
    "success": true,
    "output_match": true,
    "comparison": {
      "python_size": 1024,
      "go_size": 1024,
      "line_count_match": true
    }
  },
  "recommendations": [
    "âœ“ Outputs match perfectly - migration successful",
    "Consider adding additional edge case tests"
  ]
}
```

**Console Output**:
```
==================================================
        MIGRATION MODE DEMO - COMPLETION SUMMARY
==================================================

Migration ID: migration_1702608000
Start Time: 2025-12-14 10:00:00
Duration: 330.500 seconds

Step Results:
--------------------------------------------------------------------------------
âœ“ SUCCESS    observe               15.500s
âœ“ SUCCESS    generate               5.200s
âœ“ SUCCESS    scaffold              45.800s
âœ“ SUCCESS    verify               250.300s
âœ“ SUCCESS    report                13.700s
--------------------------------------------------------------------------------
âœ“ All 5 steps completed successfully

VERIFICATION: OUTPUTS MATCH âœ“
  Python baseline matches Go implementation perfectly

==================================================
Artifacts Generated:
  â€¢ Trace file: demo_migration\python_trace.json
  â€¢ Golden test: demo_migration\generated_golden_test.json
  â€¢ Go scaffold: demo_migration\go_scaffold\
  â€¢ Migration report: demo_migration\migration_report.json
==================================================
```

**Command-Line Usage**:
```bash
# Generate report
python migration_mode_demo.py --steps report

# View full workflow with report
python migration_mode_demo.py --full
```

---

## Demo Scripts

### Full Workflow Demo

**File**: `migration_mode_demo.py`

**Description**: Complete demonstration of all 5 steps in sequence

**Features**:
- Colored console output for clarity
- Detailed timing and progress information
- Error handling and recovery
- Comprehensive reporting
- Artifact generation

**Usage**:
```bash
# Run complete workflow
python migration_mode_demo.py --full

# Verbose mode
python migration_mode_demo.py --full --verbose

# Custom demos
python migration_mode_demo.py
```

### Windows Batch Script

**File**: `demo.bat`

**Description**: Easy-to-use batch script for Windows users

**Features**:
- Environment validation (Python, Go)
- Automatic directory setup
- Error handling
- User-friendly messages

**Usage**:
```batch
REM Execute complete demo
demo.bat

REM Or double-click the .bat file in Windows Explorer
```

### Individual Components

**Trace Capture**: `trace_capture_example.py`
- Standalone trace capture utility
- File I/O monitoring
- Execution timing

**Golden Test Generator**: `trace_to_golden_converter.py`
- Convert traces to golden tests
- Batch processing support
- Flexible output options

**Golden Test Runner**: `golden_test_runner.py`
- Execute golden test suites
- Verify assertions
- Report test results

---

## Golden Test Format

### Overview

Golden tests capture expected behavior in a machine-readable format for regression testing.

**Key Components**:
- **Test Suite**: Collection of related test cases
- **Test Case**: Individual test with setup, execution, and assertions
- **Assertions**: Programmatic checks to verify behavior

### Core Schema

```json
{
  "test_suite_name": "string",
  "format_version": "string",
  "description": "string",
  "tests": [
    {
      "test_id": "string",
      "description": "string",
      "enabled": true|false,
      "priority": "low|medium|high",
      "setup": {
        "create_files": [
          {
            "path": "string",
            "content": "string",
            "encoding": "utf-8"
          }
        ],
        "delete_files": ["string"],
        "environment": {}
      },
      "input": {
        "command": ["string"],
        "working_dir": "string",
        "stdin": "string|null",
        "timeout_seconds": 30
      },
      "expected_output": {
        "exit_code": 0,
        "stdout": "string",
        "stderr": "string",
        "partial_match": false
      },
      "expected_files": [
        {
          "path": "string",
          "should_exist": true,
          "content_match": "string",
          "content_regex": "string|null"
        }
      ],
      "assertions": [
        {
          "type": "exit_code",
          "expected_code": 0
        },
        {
          "type": "file_content_equals",
          "file_path": "string",
          "expected_content": "string"
        }
      ],
      "cleanup": {
        "delete_files": ["string"],
        "delete_dirs": []
      }
    }
  ],
  "metadata": {
    "created_by": "MigrationDemo",
    "created_date": "2025-12-14",
    "target_script": "string"
  }
}
```

### Assertion Types

| Type | Parameters | Description |
|------|-----------|-------------|
| `exit_code` | `expected_code` | Check process exit code |
| `stdout_equals` | `expected` | Exact stdout match |
| `stdout_contains` | `expected_substring` | Substring in stdout |
| `file_exists` | `file_path` | File must exist |
| `file_not_exists` | `file_path` | File must not exist |
| `file_content_equals` | `file_path`, `expected_content` | Exact file content |
| `file_content_regex` | `file_path`, `pattern` | Regex file content |
| `directory_exists` | `directory_path` | Directory must exist |
| `file_count_in_dir` | `directory`, `pattern`, `expected_count` | Count matching files |

See `golden_test_format.md` for complete specification.

---

## Usage Examples

### Example 1: Basic File Processing Migration

**Objective**: Migrate a simple text uppercase processor from Python to Go

**Python Source** (`simple_file_processor_example.py`):
```python
def process_file(input_path, output_path):
    # Read input
    with open(input_path, 'r') as f:
        content = f.read()
    
    # Process
    processed = content.upper()
    
    # Write output
    with open(output_path, 'w') as f:
        f.write(processed)
    
    return "Success"
```

**Steps**:
1. **Observe**: Run Python processor with sample input
2. **Generate**: Create golden test from execution
3. **Scaffold**: Generate Go equivalent
4. **Verify**: Compare Python and Go outputs
5. **Report**: Generate migration summary

**Commands**:
```bash
# Setup
mkdir migration_demo && cd migration_demo
echo "hello world" > input.txt

# Run complete workflow
python migration_mode_demo.py --full --verbose
```

### Example 2: CSV Processing Migration

**Objective**: Migrate CSV processing pipeline

**Python Source**:
```python
import csv

def process_csv(input_csv, output_csv):
    with open(input_csv, 'r') as infile:
        reader = csv.DictReader(infile)
        rows = list(reader)
    
    # Transform (uppercase all string fields)
    for row in rows:
        for key, value in row.items():
            if isinstance(value, str):
                row[key] = value.upper()
    
    with open(output_csv, 'w') as outfile:
        writer = csv.DictWriter(outfile, fieldnames=rows[0].keys())
        writer.writeheader()
        writer.writerows(rows)
```

**Workflow**:
1. Create test CSV
2. Capture execution trace
3. Generate golden tests
4. Scaffold Go implementation
5. Verify outputs match
6. Generate report

**Results**:
- âœ… File operations match
- âœ… Content transformations identical
- âœ… Header preservation verified
- ðŸ“Š Migration successful

### Example 3: API Client Migration

**Objective**: Migrate API client library

**Challenges**:
- Network I/O timing variations
- Non-deterministic responses
- State management differences

**Solutions**:
- Use `partial_match: true` in golden tests
- Record response snapshots
- Validate structure over exact match
- Test offline with recorded responses

---

## Troubleshooting

### Common Issues

#### Issue: "Python script execution failed"

**Symptoms**: Step 1 fails with non-zero exit code

**Solutions**:
1. Verify Python environment:
   ```bash
   python --version
   python -c "import sys; print(sys.executable)"
   ```

2. Check file paths are correct:
   ```bash
   dir /b demo_migration\test_data\
   ```

3. Run Python script manually:
   ```bash
   python simple_file_processor_example.py demo_migration\test_data\sample_input.txt demo_migration\test_data\output.txt
   ```

#### Issue: "Go compilation failed"

**Symptoms**: Step 4 fails during Go build

**Solutions**:
1. Verify Go installation:
   ```bash
   go version
   ```

2. Check Go environment:
   ```bash
   go env
   ```

3. Install Go if missing:
   - Download: https://golang.org/dl/
   - Install and add to PATH

4. Test Go compilation manually:
   ```bash
   cd demo_migration\go_scaffold
   go build -o processor src\main.go
   ```

#### Issue: "Outputs don't match"

**Symptoms**: Verification step reports differences

**Root Causes**:
- Platform-specific line endings (Windows vs Unix)
- Timing-dependent output
- Non-deterministic behavior
- Encoding differences

**Solutions**:
1. Normalize line endings:
   ```python
   # In golden test assertions
   "content_match": output.replace('\r\n', '\n')
   ```

2. Use regex patterns for flexible matching:
   ```json
   {
     "type": "file_content_regex",
     "file_path": "output.txt",
     "pattern": "HELLO.*WORLD"
   }
   ```

3. Enable partial matching:
   ```json
   {
     "expected_output": {
       "partial_match": true
     }
   }
   ```

#### Issue: "Trace file not found"

**Symptoms**: Step 2 fails to read trace file

**Solutions**:
1. Verify Step 1 completed successfully
2. Check file exists:
   ```bash
   if exist demo_migration\python_trace.json (echo File exists) else (echo File missing)
   ```
3. Review Step 1 output for errors
4. Re-run complete workflow with `--full`

#### Issue: "Permission denied" errors

**Symptoms**: File access errors during execution

**Solutions**:
1. Run as administrator if needed
2. Check file permissions:
   ```bash
   icacls demo_migration\* /T
   ```
3. Clean up and retry:
   ```bash
   rmdir /s /q demo_migration
   demo.bat
   ```

### Debug Mode

Enable verbose output for detailed debugging:

```bash
# Python script
python migration_mode_demo.py --full --verbose

# Batch script
demo.bat  > debug.log 2>&1
type debug.log
```

### Recovery Steps

If workflow fails mid-execution:

1. **Check current step**:
   ```bash
   echo Last completed step from console output
   ```

2. **Clean environment**:
   ```bash
   rmdir /s /q demo_migration
   ```

3. **Resume from failed step**:
   ```bash
   # Example: Resume from Step 3
   python migration_mode_demo.py --steps scaffold verify report
   ```

4. **Manual recovery**:
   ```bash
   # Complete individual steps manually
   python migration_mode_demo.py --steps observe
   python migration_mode_demo.py --steps generate
   python migration_mode_demo.py --steps scaffold
   python migration_mode_demo.py --steps verify
   python migration_mode_demo.py --steps report
   ```

### Performance Optimization

For large migrations:

1. **Increase timeouts**:
   ```json
   {
     "input": {
       "timeout_seconds": 300  // 5 minutes
     }
   }
   ```

2. **Parallel execution**:
   ```bash
   # Run independent steps in parallel
   start python migration_mode_demo.py --steps observe
   start python migration_mode_demo.py --steps scaffold
   ```

3. **Incremental migration**:
   ```bash
   # Migrate function-by-function
   python migration_mode_demo.py --steps observe generate verify report
   ```

### Support Commands

List all available commands:
```bash
python migration_mode_demo.py --help
python trace_to_golden_converter.py --help
python trace_capture_example.py --help
python golden_test_runner.py --help
```

---

## Advanced Topics

### Custom Test Generators

Extend golden test generation with custom logic:

```python
from trace_to_golden_converter import TraceConverter

class CustomTraceConverter(TraceConverter):
    def convert_execution(self):
        # Custom execution logic
        self.golden_test.execution['command'] = self.trace_data.get('command')
        
        # Add custom environment
        self.golden_test.execution['environment'] = {
            'CUSTOM_VAR': 'value'
        }
```

### Integration with CI/CD

Add migration validation to pipelines:

**`.github/workflows/migration.yml`**:
```yaml
name: Migration Validation
on: [push, pull_request]

jobs:
  migration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
      - name: Setup Go
        uses: actions/setup-go@v2
      - name: Run Migration Demo
        run: |
          python migration_mode_demo.py --full --verbose
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          path: demo_migration/
```

### Extending to Other Languages

To support new source/target languages:

1. **Update trace capture**:
   ```python
   if language == "javascript":
       return self._capture_nodejs_trace()
   ```

2. **Add scaffold templates**:
   ```python
   templates = {
       "go": "go_template.tmpl",
       "rust": "rust_template.tmpl"
   }
   ```

3. **Implement verification adapters**:
   ```python
   class GoVerifier(Verifier):
       def compile(self): ...
       def execute(self): ...
   ```

---

## Summary

Migration Mode provides a systematic, test-driven approach to code migration that ensures:

âœ“ **Behavior Preservation**: Golden tests capture and validate expected behavior  
âœ“ **Automated Validation**: Step-by-step verification reduces manual effort  
âœ“ **Comprehensive Documentation**: Reports track all migration activities  
âœ“ **Risk Mitigation**: Early detection of behavioral differences  
âœ“ **Extensibility**: Easily adaptable to different languages and frameworks

### Quick Start Summary

1. **Run Demo**:
   ```batch
   demo.bat
   ```

2. **Examine Results**:
   - Trace: `demo_migration\python_trace.json`
   - Tests: `demo_migration\generated_golden_test.json`
   - Go Code: `demo_migration\go_scaffold\`
   - Report: `demo_migration\migration_report.json`

3. **Manual Steps**:
   ```bash
   # Individual steps
   python migration_mode_demo.py --steps observe
   python migration_mode_demo.py --steps generate
   python migration_mode_demo.py --steps scaffold
   python migration_mode_demo.py --steps verify
   python migration_mode_demo.py --steps report
   ```

### Key Files

| File | Purpose |
|------|---------|
| `migration_mode_demo.py` | Main demo orchestration |
| `demo.bat` | Windows batch script |
| `simple_file_processor_example.py` | Example Python source |
| `golden_test_format.md` | Golden test specification |
| `trace_capture_example.py` | Execution trace utility |
| `trace_to_golden_converter.py` | Test generation utility |
| `golden_test_runner.py` | Test execution engine |

---

## Next Steps

1. âœ… **Complete Demo**: Run `demo.bat` to see full workflow
2. ðŸ“– **Read Docs**: Review `golden_test_format.md` for test specification
3. ðŸ”§ **Customize**: Adapt demo for your specific migration needs
4. ðŸ§ª **Extend**: Add support for new languages or frameworks
5. ðŸ“Š **Analyze**: Review migration report for improvements

---

## References

- [Golden Test Format Specification](golden_test_format.md)
- [Trace Format](trace_format.py)
- [Demo Script](migration_mode_demo.py)
- [Batch Script](demo.bat)

**Document Version**: 1.0.0  
**Last Updated**: 2025-12-14  
**Maintainer**: Migration Mode Development Team

---

For questions or issues, please refer to the troubleshooting section or create an issue in the project repository.
