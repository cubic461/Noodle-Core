<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoodleCore Enhanced IDE</title>

    <!-- Monaco Editor -->
    <script src="/monaco-editor/min/vs/loader.min.js"></script>

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- NoodleCore IDE Styles -->
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
            height: 100vh;
        }

        /* Main IDE Layout */
        .ide-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* File Explorer */
        .file-explorer {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .file-explorer.collapsed {
            width: 50px;
        }

        .explorer-header {
            padding: 8px 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .explorer-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .explorer-controls {
            display: flex;
            gap: 4px;
        }

        .control-btn {
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 4px;
            border-radius: 2px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #3c3c3c;
            color: #ffffff;
        }

        /* Search Bar */
        .search-container {
            padding: 8px 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }

        .search-input {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #464647;
            color: #cccccc;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
            outline: none;
        }

        .search-input:focus {
            border-color: #007acc;
            box-shadow: 0 0 0 1px #007acc;
        }

        /* File Tree */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .file-tree ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 13px;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.selected {
            background: #094771;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Editor Area */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .editor-header {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
        }

        .editor-tabs {
            flex: 1;
            display: flex;
            overflow-x: auto;
        }

        .editor-tab {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d30;
            border-right: 1px solid #3e3e42;
            cursor: pointer;
            min-width: 120px;
            max-width: 200px;
        }

        .editor-tab.active {
            background: #1e1e1e;
        }

        .tab-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }

        .tab-name {
            flex: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            opacity: 0.6;
        }

        .tab-close:hover {
            background: #f48771;
            opacity: 1;
        }

        /* Monaco Editor Container */
        .monaco-editor-container {
            flex: 1;
            position: relative;
        }

        #monaco-editor {
            width: 100%;
            height: 100%;
        }

        /* Status Indicators */
        .status-bar {
            background: #007acc;
            color: white;
            padding: 4px 12px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .status-indicators {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            transition: background-color 0.3s ease;
        }

        .status-dot.active {
            background: #4ec9b0;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: #2d2d30;
            color: #d4d4d4;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-size: 14px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #4ec9b0;
        }

        .toast.error {
            border-left: 4px solid #f48771;
        }

        .toast.warning {
            border-left: 4px solid #ffcc02;
        }

        .toast.info {
            border-left: 4px solid #007acc;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .file-explorer {
                width: 200px;
            }

            .explorer-title {
                font-size: 11px;
            }

            .search-input {
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Main IDE Container -->
    <div class="ide-container">
        <!-- File Explorer -->
        <div id="file-explorer" class="file-explorer">
            <div class="explorer-header">
                <div class="explorer-title">Explorer</div>
                <div class="explorer-controls">
                    <button class="control-btn" onclick="refreshFileTree()">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button class="control-btn" onclick="collapseExplorer()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="file-search" placeholder="Search files..."
                    onkeyup="searchFiles()">
            </div>

            <div id="file-tree" class="file-tree">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor-area">
            <div class="editor-header">
                <div id="editor-tabs" class="editor-tabs">
                    <!-- Dynamic tab content -->
                </div>
                <div class="editor-controls">
                    <button class="control-btn" onclick="runCodeAnalysis()" title="Run AI Code Analysis">
                        <i class="fas fa-lightbulb"></i>
                    </button>
                    <button class="control-btn" onclick="getAISuggestions()" title="Get AI Suggestions">
                        <i class="fas fa-brain"></i>
                    </button>
                    <button class="control-btn" onclick="runCodeReview()" title="AI Code Review">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="control-btn" onclick="toggleCollaboration()" title="Noodle-Net Collaboration">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>

            <div class="monaco-editor-container">
                <div id="monaco-editor"></div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-indicators">
            <div class="status-item">
                <div id="connection-status" class="status-dot"></div>
                <span>Server</span>
            </div>
            <div class="status-item">
                <div id="editor-status" class="status-dot"></div>
                <span>Editor</span>
            </div>
        </div>
        <div style="flex: 1;"></div>
        <div>Ready</div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global Variables
        let monacoEditor = null;
        let socket = null;
        let currentFile = null;
        let openFiles = new Map();
        let monacoLoaded = false;
        let editorInitialized = false;

        // Enhanced Monaco Editor initialization with comprehensive error handling
        function initializeMonacoLoader() {
            console.log('üöÄ Starting Monaco Editor initialization...');

            // Check if require is available
            if (typeof require === 'undefined') {
                console.error('‚ùå require.js not loaded - loader.min.js missing or failed to load');
                showEditorError('Failed to load Monaco Editor: require.js not available');
                return;
            }

            console.log('‚úÖ require.js is available');

            // Configure require.js with proper paths
            require.config({
                paths: {
                    'vs': '/monaco-editor/min/vs'
                }
            });

            console.log('üìç Require.js configured with path: /monaco-editor/min/vs');

            // Create timeout for loading
            const loadTimeout = setTimeout(() => {
                console.error('‚è∞ Monaco Editor loading timeout (10 seconds)');
                showEditorError('Monaco Editor loading timeout - check network connectivity');
            }, 10000);

            console.log('‚è±Ô∏è Loading Monaco Editor with 10-second timeout...');

            // Load Monaco Editor
            require(['vs/editor/editor.main'], function (monaco) {
                clearTimeout(loadTimeout);
                console.log('üéâ Monaco Editor loaded successfully!');
                console.log('üìä Monaco object available:', !!monaco);
                console.log('üìä Monaco editor available:', !!monaco.editor);

                if (!monaco || !monaco.editor) {
                    throw new Error('Monaco editor modules not properly loaded');
                }

                monacoLoaded = true;
                initializeMonacoEditor(monaco);
            }, function (error) {
                clearTimeout(loadTimeout);
                console.error('üí• Monaco Editor loading failed:', error);

                let errorMessage = 'Monaco Editor failed to load. ';
                if (error.message) {
                    errorMessage += 'Error: ' + error.message;
                } else if (typeof error === 'string') {
                    errorMessage += 'Error: ' + error;
                } else {
                    errorMessage += 'Unknown error - check browser console for details';
                }

                showEditorError(errorMessage);
                fallbackToBasicEditor();
            });
        }

        function initializeMonacoEditor(monaco) {
            try {
                console.log('üîß Initializing Monaco Editor instance...');

                const editorContainer = document.getElementById('monaco-editor');
                if (!editorContainer) {
                    throw new Error('Monaco editor container not found');
                }

                console.log('üì¶ Editor container found, creating instance...');

                monacoEditor = monaco.editor.create(editorContainer, {
                    value: `#!/usr/bin/env python3
# Welcome to NoodleCore Enhanced IDE
# 
# ‚úÖ Monaco Editor is now working correctly!
# üéØ This is a fully functional code editor
# üöÄ Start coding with confidence!

def main():
    print("Hello from Monaco Editor!")
    print("‚úÖ JavaScript initialization successful")
    print("‚úÖ Editor functionality confirmed")

if __name__ == "__main__":
    main()
`,
                    language: 'python',
                    theme: 'vs-dark',
                    fontSize: 14,
                    lineNumbers: 'on',
                    minimap: { enabled: true },
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    wordWrap: 'on',
                    formatOnPaste: true,
                    formatOnType: true,
                    suggestOnTriggerCharacters: true,
                    acceptSuggestionOnEnter: 'on',
                    bracketMatching: 'always',
                    autoIndent: 'advanced',
                    contextmenu: true,
                    mouseWheelZoom: true,
                    smoothScrolling: true,
                    cursorBlinking: 'blink',
                    cursorSmoothCaretAnimation: 'on',
                    folding: true,
                    foldingHighlight: true,
                    showFoldingControls: 'always',
                    bracketPairColorization: { enabled: true },
                    guides: {
                        bracketPairs: true,
                        indentation: true
                    }
                });

                if (!monacoEditor) {
                    throw new Error('Failed to create Monaco Editor instance');
                }

                console.log('üéä Monaco Editor instance created successfully!');
                editorInitialized = true;

                // Update status indicators
                updateEditorStatus(true);

                // Add editor event listeners
                monacoEditor.onDidFocusEditorText(() => {
                    console.log('üìù Editor focused');
                });

                monacoEditor.onDidBlurEditorText(() => {
                    console.log('üìù Editor blurred');
                });

                // Initialize rest of IDE features
                initializeIDE();
                connectWebSocket();
                loadInitialFiles();

                showToast('üéâ Monaco Editor loaded successfully!', 'success');

            } catch (error) {
                console.error('üí• Monaco Editor initialization error:', error);
                showEditorError('Failed to initialize Monaco Editor: ' + error.message);
                fallbackToBasicEditor();
            }
        }

        function fallbackToBasicEditor() {
            console.log('‚ö†Ô∏è Switching to fallback editor...');

            const editorContainer = document.getElementById('monaco-editor');
            if (editorContainer) {
                editorContainer.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #2d2d30; color: #d4d4d4; border: 2px solid #f48771; border-radius: 8px; margin: 40px;">
                        <h3 style="color: #f48771; margin-bottom: 16px;">‚ö†Ô∏è Monaco Editor Unavailable</h3>
                        <p style="margin-bottom: 20px;">The Monaco Editor failed to load properly.</p>
                        <div style="background: #1e1e1e; padding: 16px; border-radius: 4px; margin: 16px 0; text-align: left;">
                            <strong>Troubleshooting steps:</strong>
                            <ol style="margin: 8px 0; padding-left: 20px;">
                                <li>Check your internet connection</li>
                                <li>Clear browser cache (Ctrl+Shift+Delete)</li>
                                <li>Hard refresh the page (Ctrl+F5)</li>
                                <li>Check browser console for errors</li>
                            </ol>
                        </div>
                        <button onclick="location.reload()" style="background: #007acc; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîÑ Reload Page
                        </button>
                    </div>
                `;
            }

            // Still initialize other features
            updateEditorStatus(false);
            initializeIDE();
            connectWebSocket();
            loadInitialFiles();
        }

        function showEditorError(message) {
            console.error('üö® Editor Error:', message);
            showToast('‚ö†Ô∏è Editor Error: ' + message, 'error');
            updateEditorStatus(false);
        }

        function updateEditorStatus(working) {
            const editorDot = document.getElementById('editor-status');
            if (editorDot) {
                editorDot.className = `status-dot ${working ? 'active' : ''}`;
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMonacoLoader);
        } else {
            initializeMonacoLoader();
        }

        function initializeIDE() {
            console.log('üèóÔ∏è Initializing IDE features...');
            updateStatusIndicators();
            setupKeyboardShortcuts();
        }

        function connectWebSocket() {
            console.log('üîå Connecting to WebSocket...');
            try {
                socket = io('http://localhost:8080', {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log('‚úÖ WebSocket connected');
                    showToast('Connected to NoodleCore server', 'success');
                    updateConnectionStatus(true);
                });

                socket.on('disconnect', () => {
                    console.log('‚ö†Ô∏è WebSocket disconnected');
                    showToast('Disconnected from server', 'warning');
                    updateConnectionStatus(false);
                });

                socket.on('connect_error', (error) => {
                    console.log('‚ö†Ô∏è WebSocket connection error:', error);
                    showToast('Server connection failed', 'warning');
                    updateConnectionStatus(false);
                });

            } catch (error) {
                console.log('‚ö†Ô∏è WebSocket initialization failed:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const connectionDot = document.getElementById('connection-status');
            if (connectionDot) {
                connectionDot.className = `status-dot ${connected ? 'active' : ''}`;
            }
        }

        function updateStatusIndicators() {
            updateConnectionStatus(false); // Will be updated by WebSocket
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            if (currentFile) {
                                showToast('File save functionality coming soon!', 'info');
                            }
                            break;
                        case 'w':
                            e.preventDefault();
                            if (currentFile) {
                                showToast('File close functionality coming soon!', 'info');
                            }
                            break;
                    }
                }
            });
        }

        // File Management
        function openFile(filePath, content = '') {
            console.log('üìÇ Opening file:', filePath);

            // Check if file is already open
            for (let [path, tab] of openFiles) {
                if (path === filePath) {
                    selectTab(path);
                    return;
                }
            }

            // Create new tab
            const tabId = `tab-${Date.now()}`;
            const tabName = filePath.split('/').pop();

            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.id = tabId;
            tab.onclick = () => selectTab(filePath);

            tab.innerHTML = `
                <div class="tab-icon">
                    <i class="fas fa-file-code"></i>
                </div>
                <div class="tab-name">${tabName}</div>
                <div class="tab-close" onclick="closeFile('${filePath}', event)">
                    <i class="fas fa-times"></i>
                </div>
            `;

            document.getElementById('editor-tabs').appendChild(tab);

            // Set editor content
            if (monacoEditor && editorInitialized) {
                monacoEditor.setValue(content);
            }

            // Store open file
            openFiles.set(filePath, {
                tabId: tabId,
                content: content,
                originalContent: content
            });

            // Select the new tab
            selectTab(filePath);
        }

        function closeFile(filePath, event) {
            event.stopPropagation();

            // Remove tab
            const fileInfo = openFiles.get(filePath);
            if (fileInfo) {
                document.getElementById(fileInfo.tabId).remove();
                openFiles.delete(filePath);
            }

            // If this was the active file, switch to another open file or clear editor
            if (currentFile === filePath) {
                const remainingFiles = Array.from(openFiles.keys());
                if (remainingFiles.length > 0) {
                    selectTab(remainingFiles[0]);
                } else {
                    if (monacoEditor && editorInitialized) {
                        monacoEditor.setValue('');
                    }
                    currentFile = null;
                }
            }
        }

        function selectTab(filePath) {
            // Update tab selection
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const fileInfo = openFiles.get(filePath);
            if (fileInfo) {
                document.getElementById(fileInfo.tabId).classList.add('active');
                currentFile = filePath;

                // Load file content
                if (monacoEditor && editorInitialized) {
                    monacoEditor.setValue(fileInfo.content);
                }
            }
        }

        function loadInitialFiles() {
            console.log('üìö Loading initial files...');

            // Open welcome file
            openFile('welcome.py', `#!/usr/bin/env python3
# Welcome to NoodleCore Enhanced IDE
# 
# ‚úÖ Monaco Editor Status: WORKING
# üéØ All core IDE features are operational
# üöÄ Ready for development!

def hello_world():
    print("Hello from Monaco Editor!")
    print("‚úÖ JavaScript initialization: SUCCESS")
    print("‚úÖ Editor functionality: CONFIRMED")
    print("‚úÖ NoodleCore IDE: READY")

if __name__ == "__main__":
    hello_world()
`);
        }

        function refreshFileTree() {
            showToast('File tree refresh coming soon!', 'info');
        }

        function searchFiles() {
            const query = document.getElementById('file-search').value.toLowerCase();
            const items = document.querySelectorAll('.file-item');

            items.forEach(item => {
                const name = item.querySelector('.file-name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        function collapseExplorer() {
            const explorer = document.getElementById('file-explorer');
            explorer.classList.toggle('collapsed');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
                // ===== NOODLECORE API INTEGRATION FUNCTIONS =====

                // AI Analysis Functions
                async function runCodeAnalysis() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        const content = monacoEditor.getValue();
                        if (!content.trim()) {
                            showToast('No code to analyze', 'warning');
                            return;
                        }

                        showToast('ü§ñ Running AI code analysis...', 'info');

                        const response = await axios.post('/api/v1/ai/analyze', {
                            content: content,
                            file_path: currentFile || 'untitled.py'
                        });

                        if (response.data.success) {
                            const analysis = response.data.data;
                            const results = `üìä AI Code Analysis Results:

Performance Score: ${(analysis.performance_score * 100).toFixed(1)}%
Security Score: ${(analysis.security_score * 100).toFixed(1)}%
Readability Score: ${(analysis.readability_score * 100).toFixed(1)}%

Lines of Code: ${analysis.lines_of_code}
Complexities: ${analysis.complexity_score}

Suggestions:
${analysis.suggestions.map(s => `‚Ä¢ ${s.content} (Line ${s.line_number})`).join('\n')}

Security Issues: ${analysis.security_issues.length > 0 ? analysis.security_issues.join(', ') : 'None detected'}
                    `;

                            showToast('‚úÖ AI analysis completed', 'success');
                            alert(results);
                        } else {
                            throw new Error(response.data.error || 'Analysis failed');
                        }
                    } catch (error) {
                        console.error('AI Analysis error:', error);
                        showToast(`‚ùå AI Analysis failed: ${error.message}`, 'error');
                    }
                }

                async function getAISuggestions() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        const content = monacoEditor.getValue();
                        const position = monacoEditor.getPosition();

                        showToast('üß† Getting AI suggestions...', 'info');

                        const response = await axios.post('/api/v1/ai/suggest', {
                            content: content,
                            cursor_position: position ? position.lineNumber * 1000 + position.column : 0
                        });

                        if (response.data.success) {
                            const suggestions = response.data.data;
                            const results = `üéØ AI Suggestions:

${suggestions.suggestions.map(s => `‚Ä¢ ${s.text} (${(s.confidence * 100).toFixed(0)}% confidence) - ${s.detail}`).join('\n') || 'No suggestions available'}

Response time: ${suggestions.completion_time_ms}ms`;

                            showToast('üí° AI suggestions ready', 'success');
                            alert(results);
                        } else {
                            throw new Error(response.data.error || 'Suggestions failed');
                        }
                    } catch (error) {
                        console.error('AI Suggestions error:', error);
                        showToast(`‚ùå AI Suggestions failed: ${error.message}`, 'error');
                    }
                }

                async function runCodeReview() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        const content = monacoEditor.getValue();
                        if (!content.trim()) {
                            showToast('No code to review', 'warning');
                            return;
                        }

                        showToast('üîç Running AI code review...', 'info');

                        const response = await axios.post('/api/v1/ai/review', {
                            content: content,
                            file_path: currentFile || 'untitled.py'
                        });

                        if (response.data.success) {
                            const review = response.data.data;
                            const results = `üìã AI Code Review Results:

Overall Score: ${review.overall_score}/100

Issues Found:
‚Ä¢ Errors: ${review.review_summary.errors}
‚Ä¢ Warnings: ${review.review_summary.warnings}  
‚Ä¢ Info: ${review.review_summary.info}

${review.issues.length > 0 ? review.issues.map(i => `‚Ä¢ ${i.type.toUpperCase()}: ${i.message}`).join('\n') : 'No issues detected'}

Recommendations:
${review.recommendations.map(r => `‚Ä¢ ${r}`).join('\n')}`;

                            showToast('‚úÖ Code review completed', 'success');
                            alert(results);
                        } else {
                            throw new Error(response.data.error || 'Review failed');
                        }
                    } catch (error) {
                        console.error('AI Review error:', error);
                        showToast(`‚ùå AI Review failed: ${error.message}`, 'error');
                    }
                }

                // Learning System Functions
                async function getLearningStatus() {
                    try {
                        showToast('üìö Checking learning system...', 'info');

                        const response = await axios.get('/api/v1/learning/status');

                        if (response.data.success) {
                            const status = response.data.data;
                            const results = `üéì Learning System Status:

Current Model: ${status.current_model}
Active: ${status.active ? 'Yes' : 'No'}
Accuracy: ${(status.accuracy * 100).toFixed(1)}%
Training Samples: ${status.training_samples.toLocaleString()}

Progress:
‚Ä¢ Overall: ${(status.progress.overall * 100).toFixed(1)}%
‚Ä¢ Code Completion: ${(status.progress.code_completion * 100).toFixed(1)}%
‚Ä¢ Bug Detection: ${(status.progress.bug_detection * 100).toFixed(1)}%
‚Ä¢ Optimization: ${(status.progress.optimization * 100).toFixed(1)}%

Learning Rate: ${status.learning_rate}
Last Update: ${new Date(status.last_update).toLocaleString()}`;

                            showToast('üìä Learning status retrieved', 'success');
                            alert(results);
                        } else {
                            throw new Error(response.data.error || 'Status check failed');
                        }
                    } catch (error) {
                        console.error('Learning Status error:', error);
                        showToast(`‚ùå Learning status failed: ${error.message}`, 'error');
                    }
                }

                async function triggerLearningUpdate() {
                    try {
                        showToast('üöÄ Triggering learning update...', 'info');

                        const response = await axios.post('/api/v1/learning/trigger', {
                            type: 'manual'
                        });

                        if (response.data.success) {
                            const result = response.data.data;
                            showToast(`‚úÖ Learning triggered: ${result.type}`, 'success');
                            alert(`Learning update started!\n\nType: ${result.type}\nEstimated Duration: ${result.estimated_duration}\nLearning ID: ${result.learning_id}`);
                        } else {
                            throw new Error(response.data.error || 'Learning trigger failed');
                        }
                    } catch (error) {
                        console.error('Learning Trigger error:', error);
                        showToast(`‚ùå Learning trigger failed: ${error.message}`, 'error');
                    }
                }

                // Search Functions  
                async function searchFilesInWorkspace() {
                    const query = prompt('Search files in workspace:', '');
                    if (!query) return;

                    try {
                        showToast(`üîç Searching for "${query}"...`, 'info');

                        const response = await axios.get('/api/v1/search/files', {
                            params: { q: query }
                        });

                        if (response.data.success) {
                            const results = response.data.data;
                            const fileList = results.results.map(r => `‚Ä¢ ${r.name} (${r.type}) - ${r.size} bytes`).join('\n');

                            if (results.total > 0) {
                                alert(`Found ${results.total} files:\n\n${fileList}`);
                                showToast(`‚úÖ Found ${results.total} files`, 'success');
                            } else {
                                alert(`No files found for "${query}"`);
                                showToast('üìÅ No files found', 'warning');
                            }
                        } else {
                            throw new Error(response.data.error || 'Search failed');
                        }
                    } catch (error) {
                        console.error('File Search error:', error);
                        showToast(`‚ùå File search failed: ${error.message}`, 'error');
                    }
                }

                async function searchContentInCurrentFile() {
                    if (!currentFile) {
                        showToast('No file open', 'warning');
                        return;
                    }

                    const query = prompt(`Search in ${currentFile}:`, '');
                    if (!query) return;

                    try {
                        showToast(`üîç Searching content...`, 'info');

                        const response = await axios.post('/api/v1/search/content', {
                            query: query,
                            file_path: currentFile
                        });

                        if (response.data.success) {
                            const results = response.data.data;
                            const matches = results.matches.map(m => `Line ${m.line_number}: ${m.content}`).join('\n');

                            if (results.matches.length > 0) {
                                alert(`Found ${results.matches.length} matches:\n\n${matches}`);
                                showToast(`‚úÖ Found ${results.matches.length} matches`, 'success');
                            } else {
                                alert(`No matches found for "${query}" in ${currentFile}`);
                                showToast('üìÑ No content matches', 'warning');
                            }
                        } else {
                            throw new Error(response.data.error || 'Content search failed');
                        }
                    } catch (error) {
                        console.error('Content Search error:', error);
                        showToast(`‚ùå Content search failed: ${error.message}`, 'error');
                    }
                }

                // Code Execution Functions
                async function executeCurrentCode() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        const content = monacoEditor.getValue();
                        if (!content.trim()) {
                            showToast('No code to execute', 'warning');
                            return;
                        }

                        showToast('‚ö° Executing code...', 'info');

                        const response = await axios.post('/api/v1/execution/run', {
                            content: content,
                            file_name: currentFile || 'script.py',
                            environment: 'python3'
                        });

                        if (response.data.success) {
                            const result = response.data.data;
                            const output = `üöÄ Code Execution Results:

File: ${result.file_name}
Exit Code: ${result.exit_code}
Execution Time: ${result.execution_time}s
Memory Usage: ${result.memory_usage_mb}MB
CPU Usage: ${result.cpu_usage_percent}%

${result.output ? `Output:\n${result.output}` : 'No output'}
${result.error ? `Errors:\n${result.error}` : ''}`;

                            showToast('‚úÖ Code executed successfully', 'success');
                            alert(output);
                        } else {
                            throw new Error(response.data.error || 'Execution failed');
                        }
                    } catch (error) {
                        console.error('Code Execution error:', error);
                        showToast(`‚ùå Code execution failed: ${error.message}`, 'error');
                    }
                }

                async function getExecutionImprovements() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        const content = monacoEditor.getValue();
                        if (!content.trim()) {
                            showToast('No code to analyze', 'warning');
                            return;
                        }

                        showToast('üîß Analyzing for improvements...', 'info');

                        const response = await axios.post('/api/v1/execution/improve', {
                            content: content,
                            execution_history: {}
                        });

                        if (response.data.success) {
                            const result = response.data.data;
                            const suggestions = result.suggestions.map(s => `‚Ä¢ ${s.type}: ${s.suggestion} (${(s.confidence * 100).toFixed(0)}% confidence)`).join('\n');
                            const improvements = Object.entries(result.estimated_improvement).map(([k, v]) => `‚Ä¢ ${k}: ${v}`).join('\n');

                            const output = `‚ö° Execution Improvement Suggestions:

Suggestions:
${suggestions || 'No suggestions available'}

Estimated Improvements:
${improvements}

Analysis Time: ${result.analysis_time_ms}ms`;

                            showToast('‚úÖ Improvement analysis complete', 'success');
                            alert(output);
                        } else {
                            throw new Error(response.data.error || 'Improvement analysis failed');
                        }
                    } catch (error) {
                        console.error('Improvement Analysis error:', error);
                        showToast(`‚ùå Improvement analysis failed: ${error.message}`, 'error');
                    }
                }

                // Collaboration Functions
                function toggleCollaboration() {
                    if (!socket || socket.disconnected) {
                        showToast('WebSocket not connected', 'error');
                        return;
                    }

                    const sessionId = prompt('Enter collaboration session ID (or leave blank for new):', '');
                    if (!sessionId) {
                        showToast('Collaboration requires session ID', 'warning');
                        return;
                    }

                    socket.emit('join_session', {
                        session_id: sessionId,
                        user_id: 'user-' + Date.now()
                    });

                    showToast(`üë• Joined collaboration session: ${sessionId}`, 'success');
                }

                // AI Deployment Functions
                async function getAIDeploymentStatus() {
                    try {
                        showToast('üöÄ Checking AI deployment status...', 'info');

                        const response = await axios.get('/api/v1/ai/deployment/status');

                        if (response.data.success) {
                            const status = response.data.data;
                            const models = status.models.map(m => `‚Ä¢ ${m.name} (${m.version}) - ${m.status} - ${(m.accuracy * 100).toFixed(1)}% accuracy`).join('\n');
                            const infra = `Infrastructure:\n‚Ä¢ CPU: ${status.infrastructure.cpu_usage}\n‚Ä¢ Memory: ${status.infrastructure.memory_usage}\n‚Ä¢ GPU: ${status.infrastructure.gpu_usage}\n‚Ä¢ Connections: ${status.infrastructure.active_connections}`;

                            const output = `ü§ñ AI Deployment Status:

Active Models: ${status.models_deployed}
Today's Requests: ${status.total_requests_today.toLocaleString()}
Average Response: ${status.average_response_time_ms}ms
Success Rate: ${(status.success_rate * 100).toFixed(1)}%

Models:
${models}

${infra}`;

                            showToast('‚úÖ Deployment status retrieved', 'success');
                            alert(output);
                        } else {
                            throw new Error(response.data.error || 'Status check failed');
                        }
                    } catch (error) {
                        console.error('Deployment Status error:', error);
                        showToast(`‚ùå Deployment status failed: ${error.message}`, 'error');
                    }
                }

                async function deployAIModel() {
                    try {
                        const modelName = prompt('Enter model name to deploy:', '');
                        if (!modelName) return;

                        const version = prompt('Enter model version:', 'v1.0.0') || 'v1.0.0';

                        showToast(`üöÄ Deploying ${modelName}...`, 'info');

                        const response = await axios.post('/api/v1/ai/deployment/deploy', {
                            model_name: modelName,
                            version: version
                        });

                        if (response.data.success) {
                            const result = response.data.data;
                            showToast(`‚úÖ Deployment started: ${result.model_name}`, 'success');
                            alert(`Deployment initiated!\n\nModel: ${result.model_name}\nVersion: ${result.version}\nDeployment ID: ${result.deployment_id}\nEstimated Completion: ${result.estimated_completion}`);
                        } else {
                            throw new Error(response.data.error || 'Deployment failed');
                        }
                    } catch (error) {
                        console.error('AI Deployment error:', error);
                        showToast(`‚ùå AI deployment failed: ${error.message}`, 'error');
                    }
                }

                // Enhanced file management with real API integration
                async function saveCurrentFile() {
                    try {
                        if (!monacoEditor || !editorInitialized) {
                            showToast('Editor not ready', 'error');
                            return;
                        }

                        if (!currentFile) {
                            const fileName = prompt('Enter filename to save as:', 'untitled.py');
                            if (!fileName) return;
                            currentFile = fileName;
                        }

                        const content = monacoEditor.getValue();

                        showToast('üíæ Saving file...', 'info');

                        const response = await axios.post('/api/v1/ide/files/save', {
                            file_path: currentFile,
                            content: content
                        });

                        if (response.data.success) {
                            showToast('‚úÖ File saved successfully', 'success');

                            // Update file info in open files
                            const fileInfo = openFiles.get(currentFile);
                            if (fileInfo) {
                                fileInfo.content = content;
                                fileInfo.originalContent = content;
                            }
                        } else {
                            throw new Error(response.data.error || 'Save failed');
                        }
                    } catch (error) {
                        console.error('File Save error:', error);
                        showToast(`‚ùå File save failed: ${error.message}`, 'error');
                    }
                }

                async function loadWorkspaceFiles() {
                    try {
                        showToast('üìÅ Loading workspace files...', 'info');

                        const response = await axios.get('/api/v1/ide/files/list');

                        if (response.data.success) {
                            const files = response.data.data.files;
                            showToast(`‚úÖ Loaded ${files.length} files from workspace`, 'success');

                            // Auto-open first few files for demo
                            if (files.length > 0) {
                                openFile(files[0].path, `# ${files[0].name}\n# Auto-loaded from workspace`);
                            }
                        } else {
                            throw new Error(response.data.error || 'Failed to load files');
                        }
                    } catch (error) {
                        console.error('File Load error:', error);
                        showToast(`‚ùå File loading failed: ${error.message}`, 'error');
                    }
                }

                // Keyboard shortcuts - updated to use real functions
                function setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            switch (e.key) {
                                case 's':
                                    e.preventDefault();
                                    saveCurrentFile();
                                    break;
                                case 'w':
                                    e.preventDefault();
                                    if (currentFile) {
                                        closeFile(currentFile, { stopPropagation: () => { } });
                                    }
                                    break;
                                case 'r':
                                    e.preventDefault();
                                    executeCurrentCode();
                                    break;
                                case 'a':
                                    e.preventDefault();
                                    runCodeAnalysis();
                                    break;
                                case 'l':
                                    e.preventDefault();
                                    getLearningStatus();
                                    break;
                                case 'f':
                                    e.preventDefault();
                                    if (e.shiftKey) {
                                        searchContentInCurrentFile();
                                    } else {
                                        searchFilesInWorkspace();
                                    }
                                    break;
                            }
                        }
                    });
                }
            }, 5000);
        }

        // Debug helper
        function debugMonaco() {
            console.log('üîç Monaco Debug Info:');
            console.log('- monacoLoaded:', monacoLoaded);
            console.log('- editorInitialized:', editorInitialized);
            console.log('- monacoEditor:', !!monacoEditor);
            console.log('- require available:', typeof require !== 'undefined');
            console.log('- window.monaco:', !!window.monaco);

            if (monacoEditor) {
                console.log('- Editor model:', !!monacoEditor.getModel());
                console.log('- Editor container size:', {
                    width: document.getElementById('monaco-editor').offsetWidth,
                    height: document.getElementById('monaco-editor').offsetHeight
                });
            }
        }

        // Make debug function available globally
        window.debugMonaco = debugMonaco;

        console.log('üéØ NoodleCore Enhanced IDE loaded - Ready to initialize Monaco Editor!');
    </script>
</body>

</html>