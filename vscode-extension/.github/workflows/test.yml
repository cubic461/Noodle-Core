name: Noodle VS Code Extension Tests

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    NODE_VERSION: 18
    NOODLE_TEST_TIMEOUT: 60000

jobs:
    test:
        name: Test Extension
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: [16.x, 18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-${{ matrix.node-version }}-

            - name: Install dependencies
              run: npm ci

            - name: Compile TypeScript
              run: npm run compile

            - name: Run unit tests
              run: npm run test:unit
              env:
                  NOODLE_TEST_MODE: unit

            - name: Run integration tests
              run: npm run test:integration
              env:
                  NOODLE_TEST_MODE: integration

            - name: Run UI tests
              run: npm run test:ui
              env:
                  NOODLE_TEST_MODE: ui

            - name: Run performance tests
              run: npm run test:performance
              env:
                  NOODLE_TEST_MODE: performance

            - name: Generate coverage report
              run: npm run test:coverage

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: true

    test-e2e:
        name: End-to-End Tests
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ubuntu-node-18-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ubuntu-node-18-

            - name: Install dependencies
              run: npm ci

            - name: Compile TypeScript
              run: npm run compile

            - name: Install VS Code
              run: |
                  npm install -g vsce
                  npm install -g @vscode/test-electron

            - name: Run E2E tests
              run: npm run test:e2e
              env:
                  NOODLE_TEST_MODE: e2e

            - name: Package extension
              run: npm run package

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Run security audit
              run: npm audit --audit-level moderate

            - name: Run dependency check
              run: npm ci

    lint:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ubuntu-node-18-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ubuntu-node-18-

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check TypeScript compilation
              run: npm run compile --noEmit

    build:
        name: Build Extension
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ubuntu-node-18-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ubuntu-node-18-

            - name: Install dependencies
              run: npm ci

            - name: Compile TypeScript
              run: npm run compile

            - name: Package extension
              run: npm run package

            - name: Upload build artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: extension-package
                  path: "*.vsix"
