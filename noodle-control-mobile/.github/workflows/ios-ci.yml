name: iOS CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios/**'
      - 'lib/**'
      - 'pubspec.yaml'
      - '.github/workflows/ios-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'lib/**'
      - 'pubspec.yaml'

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  build_ios:
    needs: test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Install CocoaPods
      uses: maxim-lobanov/setup-cocoapods@v1
      with:
        version: latest
        
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install
        
    - name: Build iOS (debug)
      run: |
        flutter build ios --debug --simulator --flavor development
        
    - name: Build iOS (release)
      if: github.ref == 'refs/heads/main'
      run: |
        flutter build ios --release --no-codesign --flavor production
        
    - name: Create IPA
      if: github.ref == 'refs/heads/main'
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath $PWD/build/Runner.xcarchive \
          archive
        
        xcodebuild -exportArchive \
          -archivePath $PWD/build/Runner.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath $PWD/build
          
    - name: Upload IPA artifacts
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v3
      with:
        name: ios-ipa
        path: ios/build/*.ipa

  deploy_ios:
    needs: build_ios
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download IPA
      uses: actions/download-artifact@v3
      with:
        name: ios-ipa
        path: ios/build/
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
        working-directory: ios
        
    - name: Install Fastlane
      run: |
        cd ios
        bundle install
        
    - name: Deploy to App Store
      run: |
        cd ios
        bundle exec fastlane deploy_to_appstore
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_KEY_CONTENT }}

  security_scan:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run security scan
      run: |
        flutter pub deps --style=tree
        # Add additional security scanning tools here